name: Safe Deploy - No DB/Ollama Update

on:
  push:
    branches: [main]
    paths:
      - 'static/**'
      - 'api/**'
      - '.github/workflows/**'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment target'
        required: true
        default: 'alpha'
        type: choice
        options:
          - alpha
          - release
          - both

jobs:
  # ==================== Áîü‰∫ßÁéØÂ¢É (31.65) ====================
  deploy-production:
    name: Deploy Production (31.65) - Safe
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'release' || github.event.inputs.environment == 'both'))
    steps:
      - name: Trigger Safe Deployment to 31.65
        run: |
          echo "üöÄ Triggering SAFE deployment to production (31.65)..."
          echo "‚ö†Ô∏è  This will NOT update Ollama or Database"
          
          curl -X POST "${{ secrets.DEPLOY_WEBHOOK_URL }}?token=${{ secrets.DEPLOY_TOKEN }}&tupe=release" \
            -H "Content-Type: application/json" \
            -d '{
              "event": "release",
              "repository": "${{ github.repository }}",
              "ref": "${{ github.ref }}",
              "sha": "${{ github.sha }}",
              "release": {
                "tag_name": "${{ github.event.release.tag_name || 'manual' }}",
                "name": "${{ github.event.release.name || 'Manual Deploy' }}"
              },
              "safe_mode": true,
              "skip_services": ["ollama", "postgresql", "redis"]
            }' \
            -w "\nHTTP Status: %{http_code}\n" \
            --max-time 60
          
          echo "‚úÖ Production deployment triggered"
          echo "‚ö†Ô∏è  Note: Ollama and Database services will NOT be restarted"

  # ==================== ÊµãËØïÁéØÂ¢É (31.66) ====================
  deploy-test:
    name: Deploy Test (31.66) - Safe
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'alpha' || github.event.inputs.environment == 'both'))
    steps:
      - name: Trigger Safe Deployment to 31.66
        run: |
          echo "üß™ Triggering SAFE deployment to test (31.66)..."
          echo "‚ö†Ô∏è  This will NOT update Ollama or Database"
          
          curl -X POST "${{ secrets.DEPLOY_WEBHOOK_URL }}?token=${{ secrets.DEPLOY_TOKEN }}&tupe=alpha" \
            -H "Content-Type: application/json" \
            -d '{
              "event": "push",
              "repository": "${{ github.repository }}",
              "ref": "${{ github.ref }}",
              "sha": "${{ github.sha }}",
              "commit_message": "${{ github.event.head_commit.message || 'Manual Deploy' }}",
              "safe_mode": true,
              "skip_services": ["ollama", "postgresql", "redis"]
            }' \
            -w "\nHTTP Status: %{http_code}\n" \
            --max-time 60
          
          echo "‚úÖ Test deployment triggered"
          echo "‚ö†Ô∏è  Note: Ollama and Database services will NOT be restarted"

  # ==================== ÈÄöÁü• ====================
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-test]
    if: always()
    steps:
      - name: Check deployment status
        run: |
          echo "=========================================="
          echo "üìã Safe Deployment Summary"
          echo "=========================================="
          echo ""
          echo "‚úÖ What was deployed:"
          echo "   - Docker image: ghcr.io/t0ken-ai/memoryx-api:latest"
          echo "   - Static files: /data/memoryx/static"
          echo "   - API container"
          echo "   - Webhook service"
          echo ""
          echo "‚è≠Ô∏è  What was NOT touched:"
          echo "   - Ollama (192.168.31.65:11434)"
          echo "   - PostgreSQL database"
          echo "   - Redis"
          echo "   - System services"
          echo ""
          echo "Verify deployment:"
          echo "   curl https://t0ken.ai/api/health"
          echo "   curl https://t0ken.ai/"
          echo "=========================================="
